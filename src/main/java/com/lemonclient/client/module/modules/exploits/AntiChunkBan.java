package com.lemonclient.client.module.modules.exploits;

import com.lemonclient.api.event.events.PacketEvent;
import com.lemonclient.api.setting.values.BooleanSetting;
import com.lemonclient.api.setting.values.IntegerSetting;
import com.lemonclient.api.setting.values.ModeSetting;
import com.lemonclient.api.util.chat.Notification;
import com.lemonclient.api.util.misc.MessageBus;
import com.lemonclient.client.module.Category;
import com.lemonclient.client.module.Module;
import java.util.Arrays;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.GuiScreen;
import net.minecraft.network.play.client.CPacketChatMessage;
import net.minecraft.network.play.server.SPacketChunkData;

@Module.Declaration(
   name = "AntiChunkBan",
   category = Category.Exploits
)
public class AntiChunkBan extends Module {
   private static long startTime = 0L;
   ModeSetting modeThing = this.registerMode("Mode", Arrays.asList("Packet", "Kill", "Both"), "Packet");
   IntegerSetting delayTime = this.registerInteger("Kill Delay", 10, 0, 100);
   BooleanSetting disable = this.registerBoolean("Disable After Kill", false);
   @EventHandler
   Listener<PacketEvent.Receive> receiveListener = new Listener((event) -> {
      if (((String)this.modeThing.getValue()).equals("Packet") || ((String)this.modeThing.getValue()).equals("Both")) {
         if (mc.field_71439_g == null) {
            return;
         }

         if (event.getPacket() instanceof SPacketChunkData) {
            event.cancel();
         }
      }

   }, new Predicate[0]);

   public void onEnable() {
      if (mc.field_71439_g != null) {
         MessageBus.sendClientPrefixMessage("[AntiChunkBan] Note: this disables chunks loading in. If you want to be able to play normally you have to disable it", Notification.Type.INFO);
      }
   }

   public void onUpdate() {
      if (mc.field_71439_g != null) {
         if ((((String)this.modeThing.getValue()).equals("Kill") || ((String)this.modeThing.getValue()).equals("Both")) && Minecraft.func_71410_x().func_147104_D() != null) {
            if (startTime == 0L) {
               startTime = System.currentTimeMillis();
            }

            if (startTime + (long)(Integer)this.delayTime.getValue() <= System.currentTimeMillis()) {
               if (Minecraft.func_71410_x().func_147104_D() != null) {
                  Minecraft.func_71410_x().field_71442_b.field_78774_b.func_147297_a(new CPacketChatMessage("/kill"));
               }

               if (mc.field_71439_g.func_110143_aJ() <= 0.0F) {
                  mc.field_71439_g.func_71004_bE();
                  mc.func_147108_a((GuiScreen)null);
                  if ((Boolean)this.disable.getValue()) {
                     this.disable();
                  }
               }

               startTime = System.currentTimeMillis();
            }
         }

      }
   }
}
