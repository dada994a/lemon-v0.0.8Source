package com.lemonclient.client.module.modules.exploits;

import com.lemonclient.api.event.events.PacketEvent;
import com.lemonclient.api.setting.values.BooleanSetting;
import com.lemonclient.api.setting.values.IntegerSetting;
import com.lemonclient.client.module.Category;
import com.lemonclient.client.module.Module;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.item.ItemBow;
import net.minecraft.item.ItemEgg;
import net.minecraft.item.ItemEnderPearl;
import net.minecraft.item.ItemSnowball;
import net.minecraft.item.ItemStack;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketPlayerTryUseItem;
import net.minecraft.network.play.client.CPacketPlayer.Position;
import net.minecraft.network.play.client.CPacketPlayerDigging.Action;
import net.minecraft.util.EnumHand;

@Module.Declaration(
   name = "BowExploit",
   category = Category.Exploits
)
public class BowBoom extends Module {
   BooleanSetting Bows = this.registerBoolean("Bows", true);
   BooleanSetting pearls = this.registerBoolean("Pearls", true);
   BooleanSetting eggs = this.registerBoolean("Eggs", true);
   BooleanSetting snowballs = this.registerBoolean("Snowballs", true);
   IntegerSetting Timeout = this.registerInteger("Timeout", 5000, 100, 2000);
   IntegerSetting spoofs = this.registerInteger("Spoofs", 10, 1, 300);
   BooleanSetting offhand = this.registerBoolean("Offhand", false);
   BooleanSetting bypass = this.registerBoolean("Bypass", false);
   private long lastShootTime;
   @EventHandler
   private final Listener<PacketEvent.Send> onUpdate = new Listener((event) -> {
      ItemStack handStack;
      ItemStack offhandStack;
      if (event.getPacket() instanceof CPacketPlayerDigging) {
         CPacketPlayerDigging packet = (CPacketPlayerDigging)event.getPacket();
         if (packet.func_180762_c() == Action.RELEASE_USE_ITEM) {
            handStack = mc.field_71439_g.func_184586_b(EnumHand.MAIN_HAND);
            offhandStack = mc.field_71439_g.func_184586_b(EnumHand.OFF_HAND);
            if ((Boolean)this.Bows.getValue() && (handStack.func_77973_b() instanceof ItemBow || (Boolean)this.offhand.getValue() && offhandStack.func_77973_b() instanceof ItemBow)) {
               this.doSpoofs();
            }
         }
      } else if (event.getPacket() instanceof CPacketPlayerTryUseItem) {
         CPacketPlayerTryUseItem packet2 = (CPacketPlayerTryUseItem)event.getPacket();
         if (packet2.func_187028_a() == EnumHand.MAIN_HAND) {
            handStack = mc.field_71439_g.func_184586_b(EnumHand.MAIN_HAND);
            offhandStack = mc.field_71439_g.func_184586_b(EnumHand.OFF_HAND);
            if (!handStack.func_190926_b()) {
               if (!(Boolean)this.eggs.getValue() || !(handStack.func_77973_b() instanceof ItemEgg) && (!(Boolean)this.offhand.getValue() || !(offhandStack.func_77973_b() instanceof ItemEgg))) {
                  if ((Boolean)this.pearls.getValue() && (handStack.func_77973_b() instanceof ItemEnderPearl || (Boolean)this.offhand.getValue() && offhandStack.func_77973_b() instanceof ItemEnderPearl)) {
                     this.doSpoofs();
                  } else if ((Boolean)this.snowballs.getValue() && (handStack.func_77973_b() instanceof ItemSnowball || (Boolean)this.offhand.getValue() && offhandStack.func_77973_b() instanceof ItemSnowball)) {
                     this.doSpoofs();
                  }
               } else {
                  this.doSpoofs();
               }
            }
         }
      }

   }, new Predicate[0]);

   public void onEnable() {
      if (this.isEnabled()) {
         this.lastShootTime = System.currentTimeMillis();
      }

   }

   private void doSpoofs() {
      if (System.currentTimeMillis() - this.lastShootTime >= (long)(Integer)this.Timeout.getValue()) {
         this.lastShootTime = System.currentTimeMillis();
         mc.field_71439_g.field_71174_a.func_147297_a(new CPacketEntityAction(mc.field_71439_g, net.minecraft.network.play.client.CPacketEntityAction.Action.START_SPRINTING));

         for(int index = 0; index < (Integer)this.spoofs.getValue(); ++index) {
            if ((Boolean)this.bypass.getValue()) {
               mc.field_71439_g.field_71174_a.func_147297_a(new Position(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u + 1.0E-10D, mc.field_71439_g.field_70161_v, false));
               mc.field_71439_g.field_71174_a.func_147297_a(new Position(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u - 1.0E-10D, mc.field_71439_g.field_70161_v, true));
            } else {
               mc.field_71439_g.field_71174_a.func_147297_a(new Position(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u - 1.0E-10D, mc.field_71439_g.field_70161_v, true));
               mc.field_71439_g.field_71174_a.func_147297_a(new Position(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u + 1.0E-10D, mc.field_71439_g.field_70161_v, false));
            }
         }
      }

   }
}
